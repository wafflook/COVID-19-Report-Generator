(function(e){e.fn.autoKana2=function(t,a,n){var r=e.extend({katakana:false,addRubyCallback:function(e){},emptyInputCallback:function(){}},n);var i=new RegExp("[^　ぁ-ゖァ-ヶＡ-Ｚａ-ｚ０-９‘～｀！＠＃＄％＾＆＊（）＿ー－＝＋｛｝「」［］￥＼｜；：’”＜＞、。，．・？／♪€…☆→○×÷〒々〆]","g");var l=new RegExp("[^　ァ-ヶー]","g");var s=new RegExp("[ｎＮnN]","g");var o=new RegExp("[^ｍＭmM]","g");var f=e(t);f.data("notSupport","0");var u=e(a);var g="";var h="";var v="";var c="";var d=false;var p="";var b=false;var C="";var k="";var x=false;var O=navigator.userAgent.toLowerCase();var S=navigator.appVersion.toLowerCase();var m=O.indexOf("msie")>-1&&O.indexOf("opera")==-1;var y=O.indexOf("trident/7")>-1;var E=m||y;var w=O.indexOf("edge")>-1;var K=O.indexOf("firefox")>-1;var W=O.indexOf("safari")>-1&&O.indexOf("chrome")==-1;var A=O.indexOf("iphone")>-1;var R=O.indexOf("ipad")>-1;var I=A||R;var P=O.indexOf("android")>-1;var M=O.indexOf("Opera")>-1;var N=false;if(O.indexOf("chrome")>-1&&O.indexOf("opr")>-1){M=true;var G=O.indexOf("opr");if(O.substr(G+4).indexOf("42.0")>-1||O.substr(G+4).indexOf("43.0")>-1){N=true}}O.indexOf("Opera")>-1;var H=false;var L=false;if(O.indexOf("chrome")>-1&&O.indexOf("opr")==-1){H=true;var G=O.indexOf("chrome");var j=O.indexOf(" ",G);if(O.substring(G+7,j).indexOf("55.0")>-1||O.substring(G+7,j).indexOf("56.0")>-1){L=true}}var Q=O.indexOf("mobile nintendobrowser")>-1;f.on("change keyup copy paste cut",(function(e){var t=f.val();if(t.length==0){r.emptyInputCallback()}}));f.on("keyup",(function(e){if(e.keyCode===8){b=false;var t=f.val();if(t.length===0){p=""}else{if(t.substr(t.length-1)==="　")b=true}}}));f.on("focus",(function(){f.data("notSupport","0");p=f.val();if(p.length>0&&p.substr(p.length-1)==="　")b=true}));f.on("blur",(function(){if(f.data("notSupport")==="1"){alert("正しくルビを取得出来無かった可能性が有ります。")}}));f.on("compositionstart",(function(e){g="";k="";v=f.val();if(E||w||K){k=f.val().slice(f[0].selectionStart,f[0].selectionEnd);if(k.length>0){v=v.slice(0,f[0].selectionStart)+v.slice(f[0].selectionEnd,v.length);if(K&&h.length>0&&h===e.originalEvent.data){x=true}}else{if(h.length>0&&h===e.originalEvent.data){var t=u.val();u.val(t.substr(0,t.length-h.length));g=e.originalEvent.data;d=true}}}h="";C="";if(window.getSelection){if(f[0].selectionStart<f[0].selectionEnd){if(v.length>0&&v.substr(f[0].selectionStart-1,1)==="　")b=true}}if(L||N){if(f[0].selectionStart<f[0].selectionEnd||f[0].selectionEnd<v.length){C=v.substr(f[0].selectionEnd);v=v.substr(0,f[0].selectionStart)}}if(!b&&(H||M||W||Q)){for(var a=v.length-1;a>-1;a--){var n=v.substr(a,1);if(n==="　"){u.val(u.val()+n)}else{break}}}}));f.on("compositionupdate",(function(e){var t=e.originalEvent.data;var a=t.toWideCase().replace(i,"");var n=false;if(t.toWideCase().length===a.length){b=false;var r=g.toWideCase().toKatakanaCase().replace(l,"");var s=a.toWideCase().toKatakanaCase();var o=s.replace(l,"");if(r.length>0&&o.length>0&&g.toWideCase().toKatakanaCase()===s){return}if(L||N){setTimeout((function(){var e=f.val();if(C.length>0){e=e.substr(0,e.length-C.length)}if(e.substr(0,v.length)===v&&e.substr(e.length-a.length)===a){a=e.substr(v.length,e.length);s=a.toWideCase().toKatakanaCase();o=s.replace(l,"")}if(r.length>0&&a.length>0&&o.length===0){return}if(f[0].selectionStart==f.val().length){if(s.substr(s.length-1).replace(l,"").length!==0){var t="";var n=g.length-1;do{var i=g.substr(n,1).toKatakanaCase();if(i.replace(l,"").length!==0){t=g.substr(0,n+1).toKatakanaCase();break}n--}while(n>-1);if(s.substr(0,t.length)!==t.substr(0,s.length)){return}}}if(a.length>0){g=a}else{g=g.substr(0,g.length-1)}}),0)}else{if(x){if(k!==a){x=false}}if(E||w){var u=f.val();if(u.substr(0,v.length)===v){var h=u.substr(v.length,u.length-v.length);if(h!==t){T(g);v=f.val().substr(0,f.val().length-1);d=false;n=true}}}if(!n&&r.length>0&&a.length>0&&o.length===0){return}if(f[0].selectionStart==f.val().length){if(s.substr(s.length-1).replace(l,"").length!==0){var p="";var O=g.length-1;do{var S=g.substr(O,1).toKatakanaCase();if(S.replace(l,"").length!==0){p=g.substr(0,O+1).toKatakanaCase();break}O--}while(O>-1);if(s.substr(0,p.length)!==p.substr(0,s.length)){return}}}if(x){g=""}else{if(a.length>0){g=a}}x=false}}else{if(c.length-t.length===1){if(c.substr(0,t.length)===t){f.data("notSupport","1")}}}c=t;if(n){q(t,g)}}));f.on("compositionend",(function(e){var t=e.originalEvent.data;var a=f.val();h="";var n=false;if((E||w)&&t.length===0&&g.length>0&&a!==v){n=true}if(t.length>0||d||n){T(g);h=g;d=false;q(t,g);g=""}if(E||w){if(v.length<a.length){if(a.substr(0,v.length)===v){var r=a.substr(v.length,a.length-v.length);if(r==="　"){u.val(u.val()+r)}}}}}));function T(e){var t=r.katakana?e.toKatakanaCase():e.toHiraganaCase();u.val(u.val()+V(t));r.addRubyCallback(V(t))}function V(e){var t=e;if(e.toKatakanaCase().replace(l,"").replace("　","").length>0){var a=e.substring(e.length-1);if(a.replace(s,"").length===0){var n=e.substr(0,e.length-1);t=n;t+=r.katakana?"ン":"ん"}}return t}function q(e,t){if(e.replace(o,"").length===0&&t.replace(o,"").length>0){f.data("notSupport","1")}}}})(jQuery);String.prototype.toKatakanaCase=function(){return this.replace(/[\u3041-\u3096]/g,(function(e){var t=e.charCodeAt(0)+96;return String.fromCharCode(t)}))};String.prototype.toHiraganaCase=function(){return this.replace(/[\u30a1-\u30f6]/g,(function(e){var t=e.charCodeAt(0)-96;return String.fromCharCode(t)}))};String.prototype.toWideCase=function(){var e,t,a,n,r=[],i=String.prototype.toWideCase.MAPPING;for(e=0,t=this.length;e<t;){a=this.charCodeAt(e++);n=this.charCodeAt(e);switch(true){case 33<=a&&a<=126&&!(a==34||a==39||a==92):r.push(a+65248);break;case a==65395:if(n==65438){r.push(12532);e++;break}case 65398<=a&&a<=65414:if(n==65438){r.push(i[a]+1);e++;break}case 65418<=a&&a<=65422:if(n==65438||n==65439){r.push(i[a]+(n-65437));e++;break}case a in i:r.push(i[a]);break;default:r.push(a);break}}return String.fromCharCode.apply(null,r)};String.prototype.toWideCase.MAPPING={92:65509,45:8213,39:8217,34:8221,32:12288,65380:12289,65377:12290,65378:12300,65379:12301,65438:12443,65439:12444,65383:12449,65393:12450,65384:12451,65394:12452,65385:12453,65395:12454,65386:12455,65396:12456,65387:12457,65397:12458,65398:12459,65399:12461,65400:12463,65401:12465,65402:12467,65403:12469,65404:12471,65405:12473,65406:12475,65407:12477,65408:12479,65409:12481,65391:12483,65410:12484,65411:12486,65412:12488,65413:12490,65414:12491,65415:12492,65416:12493,65417:12494,65418:12495,65419:12498,65420:12501,65421:12504,65422:12507,65423:12510,65424:12511,65425:12512,65426:12513,65427:12514,65388:12515,65428:12516,65389:12517,65429:12518,65390:12519,65430:12520,65431:12521,65432:12522,65433:12523,65434:12524,65435:12525,65436:12527,65382:12530,65437:12531,65381:12539,65392:12540};